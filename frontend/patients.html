<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Patients</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="assets/css/styles.css">
  <link rel="stylesheet" href="assets/css/dashboard-styles.css">
</head>
<body>

<div class="app-container">
  <!-- === Sidebar === -->
  <nav class="sidebar">
    <!-- Sidebar Header -->
    <div class="sidebar-header">
      <a class="sidebar-brand" href="dashboard.html">
        <i class="fas fa-clinic-medical"></i>
        <span>ClinicMS</span>
      </a>
      <!-- Toggle Button -->
      <button class="sidebar-toggle" id="sidebar-toggle">
        <i class="fas fa-chevron-left"></i>
      </button>
    </div>

    <ul class="sidebar-nav">
      <li class="nav-title">General</li>
      <li class="nav-item">
        <a class="nav-link" href="dashboard.html">
          <i class="fas fa-home"></i>
          <span>Dashboard</span>
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link active" href="patients.html">
          <i class="fas fa-user-injured"></i>
          <span>Patients</span>
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="appointments.html">
          <i class="fas fa-calendar-check"></i>
          <span>Appointments</span>
        </a>
      </li>
      <li class="nav-title">Management</li>
      <li class="nav-item">
        <a class="nav-link" href="doctors.html">
          <i class="fas fa-user-md"></i>
          <span>Doctors</span>
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="bills.html">
          <i class="fas fa-file-invoice-dollar"></i>
          <span>Billing</span>
        </a>
      </li>
    </ul>
  </nav>

  <!-- === Main Wrapper (Top Bar + Content) === -->
  <div class="main-wrapper">
    <!-- === Top Bar === -->
    <header class="top-bar">
      <form class="search-form d-none d-md-block">
        <input class="form-control" type="search" placeholder="Search patients...">
      </form>
      <div class="profile-dropdown d-flex align-items-center">
        <img src="https://via.placeholder.com/150/4a6cf7/ffffff?text=U" alt="User" class="d-none d-sm-block">
        <div class="me-2 text-end d-none d-sm-block">
          <span id="userLabel" class="d-block"></span>
          <small id="userRoles" class="d-block"></small>
        </div>
        <button id="btnLogout" class="btn btn-logout btn-sm">
          <i class="fas fa-sign-out-alt me-1"></i>Logout
        </button>
      </div>
    </header>

    <!-- === Main Content === -->
    <main class="content-area">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
          <h3>Patients</h3>
          <p class="page-subtitle">Manage patient records.</p>
        </div>
        <button id="btnNew" class="btn btn-primary">
          <i class="fas fa-plus me-1"></i> New Patient
        </button>
      </div>

      <!-- Form Card (hidden by default) -->
      <div id="formCard" class="card mb-4 hidden">
        <div class="card-header">Add/Edit Patient</div>
        <div class="card-body">
          <form id="form">
            <input type="hidden" id="id">
            <div class="row g-3">
              <div class="col-md-6"><label class="form-label">Name</label><input id="name" class="form-control" placeholder="Full Name" required></div>
              <div class="col-md-6"><label class="form-label">NIC</label><input id="nic" class="form-control" placeholder="NIC"></div>
              <div class="col-md-6"><label class="form-label">Phone</label><input id="phone" class="form-control" placeholder="Phone"></div>
              <div class="col-md-6"><label class="form-label">Date of Birth</label><input id="dob" type="date" class="form-control"></div>
              <div class="col-12"><label class="form-label">Address</label><input id="address" class="form-control" placeholder="1234 Main St"></div>
              <div class="col-12"><label class="form-label">Username (for login)</label><input id="username" class="form-control" placeholder="patient_username"></div>
            </div>
            <div class="mt-3">
              <button class="btn btn-primary" type="submit">Save</button>
              <button id="btnCancel" type="button" class="btn btn-secondary">Cancel</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Patients Table -->
      <div class="card">
        <div class="card-header">All Patients</div>
        <div class="card-body table-wrapper">
          <table class="table table-striped table-hover" id="table">
            <thead><tr><th>ID</th><th>Name</th><th>NIC</th><th>Phone</th><th>DOB</th><th>Address</th><th>Action</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

    </main>
  </div>
</div>

<script src="assets/js/common.js"></script>
<script>
  initCommonNav();
  if (!getToken()) window.location = '/login.html';

  const tableBody = document.querySelector('#table tbody');

  async function load() {
    try {
      const list = await apiFetch('/patient/all');
      tableBody.innerHTML = '';
      list.forEach(p => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${p.id}</td><td>${p.name}</td><td>${p.nic||''}</td><td>${p.phone||''}</td><td>${p.dob||''}</td><td>${p.address||''}</td>
        <td>
          ${hasRole('ADMIN') || hasRole('RECEPTIONIST') ? `<button class="btn btn-sm btn-warning me-1" onclick="edit(${p.id})"><i class="fas fa-edit"></i></button>` : ''}
          ${hasRole('ADMIN') ? `<button class="btn btn-sm btn-danger" onclick="del(${p.id})"><i class="fas fa-trash-alt"></i></button>` : ''}
        </td>`;
        tableBody.appendChild(tr);
      });
    } catch (e) {
      tableBody.innerHTML = `<tr><td colspan="7" class="text-danger">Failed to load: ${e.message}</td></tr>`;
    }
  }

  document.getElementById('btnNew').addEventListener('click', () => {
    if (!hasRole('ADMIN') && !hasRole('RECEPTIONIST')) { alert('No permission'); return; }
    document.getElementById('form').reset();
    document.getElementById('id').value = '';
    document.getElementById('formCard').classList.remove('hidden');
  });
  document.getElementById('btnCancel').addEventListener('click', () => document.getElementById('formCard').classList.add('hidden'));

  document.getElementById('form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const dto = {
      name: document.getElementById('name').value,
      nic: document.getElementById('nic').value,
      phone: document.getElementById('phone').value,
      dob: document.getElementById('dob').value,
      address: document.getElementById('address').value,
      username: document.getElementById('username').value
    };
    const id = document.getElementById('id').value;
    try {
      if (id) {
        await apiFetch('/patient/' + id, { method: 'PUT', body: JSON.stringify(dto) });
      } else {
        await apiFetch('/patient/create', { method: 'POST', body: JSON.stringify(dto) });
      }
      document.getElementById('formCard').classList.add('hidden');
      load();
    } catch (err) { alert('Save failed: ' + err.message); }
  });

  window.edit = async function(id) {
    try {
      const p = await apiFetch('/patient/' + id);
      document.getElementById('id').value = p.id;
      document.getElementById('name').value = p.name;
      document.getElementById('nic').value = p.nic || '';
      document.getElementById('phone').value = p.phone || '';
      if (p.dob) document.getElementById('dob').value = p.dob.split('T')[0];
      document.getElementById('address').value = p.address || '';
      document.getElementById('username').value = p.username || '';
      document.getElementById('formCard').classList.remove('hidden');
    } catch (e) { alert('Load failed: ' + e.message); }
  };

  window.del = async function(id) {
    if (!confirm('Delete patient ' + id + '?')) return;
    try {
      await apiFetch('/patient/' + id, { method: 'DELETE' });
      load();
    } catch (e) { alert('Delete failed: ' + e.message); }
  };

  load();
</script>

<!-- JavaScript for the sidebar toggle -->
<script>
  document.getElementById('sidebar-toggle').addEventListener('click', function() {
    document.querySelector('.app-container').classList.toggle('sidebar-collapsed');
  });
</script>

</body>
</html>