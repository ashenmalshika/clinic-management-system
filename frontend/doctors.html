<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Doctors</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="assets/css/styles.css">
  <link rel="stylesheet" href="assets/css/dashboard-styles.css">
  <style>
    /* Basic style to ensure the form card is hidden by default if assets/css/dashboard-styles.css doesn't define .hidden */
    .hidden {
      display: none;
    }
  </style>
</head>
<body>

<div class="app-container">
  <nav class="sidebar">
    <div class="sidebar-header">
      <a class="sidebar-brand" href="dashboard.html">
        <i class="fas fa-clinic-medical"></i>
        <span>ClinicMS</span>
      </a>
      <button class="sidebar-toggle" id="sidebar-toggle">
        <i class="fas fa-chevron-left"></i>
      </button>
    </div>

    <ul class="sidebar-nav">
      <li class="nav-title">General</li>
      <li class="nav-item">
        <a class="nav-link" href="dashboard.html">
          <i class="fas fa-home"></i>
          <span>Dashboard</span>
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="patients.html">
          <i class="fas fa-user-injured"></i>
          <span>Patients</span>
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="appointments.html">
          <i class="fas fa-calendar-check"></i>
          <span>Appointments</span>
        </a>
      </li>
      <li class="nav-title">Management</li>
      <li class="nav-item">
        <a class="nav-link active" href="doctors.html">
          <i class="fas fa-user-md"></i>
          <span>Doctors</span>
        </a>
      </li>
      <li class="nav-item" id="sessionsNavItem">
        <a class="nav-link" href="sessions.html">
          <i class="fas fa-calendar-alt"></i>
          <span>Sessions</span>
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="bills.html">
          <i class="fas fa-file-invoice-dollar"></i>
          <span>Billing</span>
        </a>
      </li>
    </ul>
  </nav>

  <div class="main-wrapper">
    <header class="top-bar">
      <div class="profile-dropdown d-flex align-items-center ms-auto">
        <img src="https://via.placeholder.com/150/4a6cf7/ffffff?text=U" alt="User" class="d-none d-sm-block">
        <div class="me-2 text-end d-none d-sm-block">
          <span id="userLabel" class="d-block"></span>
          <small id="userRoles" class="d-block"></small>
        </div>
        <button id="btnLogout" class="btn btn-logout btn-sm">
          <i class="fas fa-sign-out-alt me-1"></i>Logout
        </button>
      </div>
    </header>

    <main class="content-area">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
          <h3>Doctors</h3>
          <p class="page-subtitle">Manage doctor profiles and specializations.</p>
        </div>
        <button id="btnNew" class="btn btn-primary">
          <i class="fas fa-plus me-1"></i> New Doctor
        </button>
      </div>

      <div id="formCard" class="card mb-4 hidden">
        <div class="card-header">Add/Edit Doctor</div>
        <div class="card-body">
          <form id="form">
            <input type="hidden" id="id">
            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label">Name</label>
                <input id="name" class="form-control" placeholder="Dr. John Doe" required>
              </div>
              <div class="col-md-4">
                <label class="form-label">Specialization</label>
                <input id="spec" class="form-control" placeholder="Cardiology">
              </div>
              <div class="col-md-4">
                <label class="form-label">Email</label>
                <input id="email" type="email" class="form-control" placeholder="john.doe@clinic.ms">
              </div>
              <div class="col-md-4">
                <label class="form-label">Username</label>
                <input id="username" type="username" class="form-control" placeholder="Username">
              </div>
              <div class="col-md-4">
                <label class="form-label">Password</label>
                <input id="password" type="password" class="form-control" placeholder="Password">
              </div>
            </div>
            <div class="mt-3">
              <button class="btn btn-primary" type="submit">Save</button>
              <button id="btnCancel" type="button" class="btn btn-secondary">Cancel</button>
            </div>
          </form>
        </div>
      </div>

      <div class="card">
        <div class="card-header">All Doctors</div>
        <div class="card-body table-wrapper">
          <div class="mb-3">
            <input type="text" id="doctorSearchInput" class="form-control" placeholder="Search by name, specialization, or email...">
          </div>
          <table class="table table-striped table-hover" id="table">
            <thead><tr><th>ID</th><th>Name</th><th>Specialization</th><th>Email</th><th>Action</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

    </main>
  </div>
</div>

<script src="assets/js/common.js"></script>
<script>
  initCommonNav();
  if (!getToken()) window.location = '/login.html';

  const tableBody = document.querySelector('#table tbody');
  const doctorSearchInput = document.getElementById('doctorSearchInput');
  let allDoctorsData = []; // Store the full list of doctors

  // --- Search/Filter Function ---
  function filterTable() {
    const filter = doctorSearchInput.value.toUpperCase();
    const rows = tableBody.getElementsByTagName('tr');

    for (let i = 0; i < rows.length; i++) {
      let row = rows[i];
      // Get the cells for Name (1), Specialization (2), and Email (3)
      const nameCell = row.getElementsByTagName('td')[1];
      const specCell = row.getElementsByTagName('td')[2];
      const emailCell = row.getElementsByTagName('td')[3];

      if (nameCell || specCell || emailCell) {
        const nameText = nameCell ? nameCell.textContent || nameCell.innerText : '';
        const specText = specCell ? specCell.textContent || specCell.innerText : '';
        const emailText = emailCell ? emailCell.textContent || emailCell.innerText : '';

        // Check if the filter is found in any of the relevant columns
        if (
                nameText.toUpperCase().indexOf(filter) > -1 ||
                specText.toUpperCase().indexOf(filter) > -1 ||
                emailText.toUpperCase().indexOf(filter) > -1
        ) {
          row.style.display = ''; // Show the row
        } else {
          row.style.display = 'none'; // Hide the row
        }
      }
    }
  }

  // --- Load Doctors Function ---
  async function load() {
    try {
      const list = await apiFetch('/doctor/all');
      allDoctorsData = list; // Store for potential client-side filtering (though not fully used in this structure)
      renderTable(list); // Render the fetched data
    } catch (e) {
      tableBody.innerHTML = `<tr><td colspan="5" class="text-danger">Failed to load: ${e.message}</td></tr>`;
    }
  }

  // --- Render Table Function (Extracted for reuse) ---
  function renderTable(list) {
    tableBody.innerHTML = '';
    if (list.length === 0) {
      tableBody.innerHTML = `<tr><td colspan="5" class="text-center">No doctors found.</td></tr>`;
      return;
    }
    list.forEach(d => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${d.id}</td><td>${d.name}</td><td>${d.specialization || ''}</td><td>${d.email || ''}</td>
        <td>
          ${hasRole('ADMIN') ? `<button class="btn btn-sm btn-danger" onclick="del(${d.id})"><i class="fas fa-trash-alt"></i></button>` : ''}
        </td>`;
      tableBody.appendChild(tr);
    });
    // After loading, ensure the filter is applied in case the user was searching
    filterTable();
  }

  // --- Event Listener for Search Input ---
  doctorSearchInput.addEventListener('keyup', filterTable);


  document.getElementById('btnNew').addEventListener('click', () => {
    if (!hasRole('ADMIN')) { alert('Only ADMIN can create.'); return; }
    document.getElementById('form').reset();
    document.getElementById('id').value = '';
    document.getElementById('formCard').classList.remove('hidden');
  });
  document.getElementById('btnCancel').addEventListener('click', () => document.getElementById('formCard').classList.add('hidden'));

  document.getElementById('form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const dto = {
      name: document.getElementById('name').value,
      specialization: document.getElementById('spec').value,
      email: document.getElementById('email').value,
      username: document.getElementById('username').value,
      password: document.getElementById('password').value
    };
    try {
      await apiFetch('/auth/signup/doctor', { method: 'POST', body: JSON.stringify(dto) });
      document.getElementById('formCard').classList.add('hidden');
      load();
    } catch (err) { alert('Save failed: ' + err.message); }
  });

  async function del(id) {
    if (!confirm('Delete doctor ' + id + '?')) return;
    try {
      await apiFetch('/doctor/' + id, { method: 'DELETE' });
      load();
    } catch (e) { alert('Delete failed: ' + e.message); }
  }

  load();
</script>
<script>// Inside the <script> tag in sessions.html OR doctors.html

initCommonNav();
if (!getToken()) window.location = '/login.html'; // Check login status

const sessionsNavItem = document.getElementById('sessionsNavItem');

// ðŸ‘‡ Logic to hide the Sessions link if the user is not a DOCTOR ðŸ‘‡
if (sessionsNavItem) {
  if (!hasRole('DOCTOR')) {
    // Hide the <li> element if the user does not have the DOCTOR role
    sessionsNavItem.style.display = 'none';
  } else {
    // Ensure it's visible for Doctors (default might be block or list-item)
    sessionsNavItem.style.display = 'list-item';
  }
}
// ðŸ‘† End Logic ðŸ‘†

// ... rest of your page-specific code (e.g., loadSessions() for sessions.html) ...</script>

<script>
  document.getElementById('sidebar-toggle').addEventListener('click', function() {
    document.querySelector('.app-container').classList.toggle('sidebar-collapsed');
  });
</script>

</body>
</html>