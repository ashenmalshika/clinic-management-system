<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Doctor Sessions</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="assets/css/styles.css">
    <link rel="stylesheet" href="assets/css/dashboard-styles.css">
    <style>
        /* Add any necessary styles here, e.g., for .hidden if not in your CSS */
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="app-container">
    <nav class="sidebar">
        <div class="sidebar-header">
            <a class="sidebar-brand" href="dashboard.html">
                <i class="fas fa-clinic-medical"></i>
                <span>ClinicMS</span>
            </a>
            <button class="sidebar-toggle" id="sidebar-toggle">
                <i class="fas fa-chevron-left"></i>
            </button>
        </div>

        <ul class="sidebar-nav">
            <li class="nav-title">General</li>
            <li class="nav-item">
                <a class="nav-link" href="dashboard.html">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="patients.html">
                    <i class="fas fa-user-injured"></i>
                    <span>Patients</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="appointments.html">
                    <i class="fas fa-calendar-check"></i>
                    <span>Appointments</span>
                </a>
            </li>
            <li class="nav-title">Management</li>
            <li class="nav-item">
                <a class="nav-link" href="doctors.html">
                    <i class="fas fa-user-md"></i>
                    <span>Doctors</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link active" href="sessions.html">
                    <i class="fas fa-calendar-alt"></i>
                    <span>Sessions</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="bills.html">
                    <i class="fas fa-file-invoice-dollar"></i>
                    <span>Billing</span>
                </a>
            </li>
        </ul>
    </nav>

    <div class="main-wrapper">
        <header class="top-bar">
            <div class="profile-dropdown d-flex align-items-center ms-auto">
                <img src="https://via.placeholder.com/150/4a6cf7/ffffff?text=U" alt="User" class="d-none d-sm-block">
                <div class="me-2 text-end d-none d-sm-block">
                    <span id="userLabel" class="d-block"></span>
                    <small id="userRoles" class="d-block"></small>
                </div>
                <button id="btnLogout" class="btn btn-logout btn-sm">
                    <i class="fas fa-sign-out-alt me-1"></i>Logout
                </button>
            </div>
        </header>

        <main class="content-area">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <h3>Session Management</h3>
                    <p class="page-subtitle">Add and manage your available doctor sessions.</p>
                </div>
                <button id="btnNewSession" class="btn btn-primary">
                    <i class="fas fa-plus me-1"></i> New Session
                </button>
            </div>

            <div id="sessionFormCard" class="card mb-4 hidden">
                <div class="card-header">Add New Session</div>
                <div class="card-body">
                    <form id="sessionForm">
                        <input type="hidden" id="sessionId">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">Day</label>
                                <select id="sessionDay" class="form-select" required>
                                    <option value="">Select Day</option>
                                    <option value="MONDAY">Monday</option>
                                    <option value="TUESDAY">Tuesday</option>
                                    <option value="WEDNESDAY">Wednesday</option>
                                    <option value="THURSDAY">Thursday</option>
                                    <option value="FRIDAY">Friday</option>
                                    <option value="SATURDAY">Saturday</option>
                                    <option value="SUNDAY">Sunday</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Start Time</label>
                                <input id="sessionStartTime" type="time" class="form-control" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">End Time</label>
                                <input id="sessionEndTime" type="time" class="form-control" required>
                            </div>
                        </div>
                        <div class="mt-3">
                            <button class="btn btn-primary" type="submit">Save Session</button>
                            <button id="btnSessionCancel" type="button" class="btn btn-secondary">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>

            <div class="card">
                <div class="card-header">Available Sessions</div>
                <div class="card-body table-wrapper">
                    <table class="table table-striped table-hover" id="sessionsTable">
                        <thead>
                        <tr>
                            <th>ID</th>
                            <th>Day</th>
                            <th>Start Time</th>
                            <th>End Time</th>
                            <th>Action</th>
                        </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>

        </main>
    </div>
</div>

<script src="assets/js/common.js"></script>
<script>
    initCommonNav();
    if (!getToken()) window.location = '/login.html'; // Ensure user is logged in

    const sessionsTableBody = document.querySelector('#sessionsTable tbody');
    const sessionFormCard = document.getElementById('sessionFormCard');
    const sessionForm = document.getElementById('sessionForm');

    // --- Session Management Functions ---

    async function loadSessions() {
        try {
            // NOTE: Replace '/session/doctor/all' with the actual endpoint for fetching sessions
            // It should ideally fetch sessions belonging to the currently logged-in doctor.
            const list = await apiFetch('/session/doctor/all');
            sessionsTableBody.innerHTML = '';

            if (list.length === 0) {
                sessionsTableBody.innerHTML = '<tr><td colspan="5" class="text-center">No sessions added yet.</td></tr>';
                return;
            }

            list.forEach(s => {
                const tr = document.createElement('tr');
                // Assuming your backend returns id, day, startTime, and endTime
                tr.innerHTML = `
          <td>${s.id}</td>
          <td>${s.day}</td>
          <td>${s.startTime}</td>
          <td>${s.endTime}</td>
          <td>
            <button class="btn btn-sm btn-danger" onclick="deleteSession(${s.id})"><i class="fas fa-trash-alt"></i></button>
          </td>`;
                sessionsTableBody.appendChild(tr);
            });
        } catch (e) {
            sessionsTableBody.innerHTML = \`<tr><td colspan="5" class="text-danger">Failed to load sessions: \${e.message}</td></tr>\`;
    }
  }

  sessionForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    const sessionData = {
      day: document.getElementById('sessionDay').value,
      startTime: document.getElementById('sessionStartTime').value,
      endTime: document.getElementById('sessionEndTime').value,
      // You may need to include the doctor's ID here, or your backend might infer it from the user's token
    };

    try {
      // NOTE: Implement your API call to save the session here
      // Replace the placeholder URL with your actual session creation endpoint
      await apiFetch('/session/create', { method: 'POST', body: JSON.stringify(sessionData) });

      sessionFormCard.classList.add('hidden');
      loadSessions(); // Reload the table after successful save
    } catch (err) {
      alert('Failed to save session: ' + err.message);
    }
  });

  async function deleteSession(id) {
    if (!confirm('Are you sure you want to delete session ' + id + '?')) return;
    try {
      // NOTE: Implement your API call to delete the session here
      await apiFetch('/session/' + id, { method: 'DELETE' });
      loadSessions();
    } catch (e) {
      alert('Delete failed: ' + e.message);
    }
  }

  // --- UI Event Listeners ---

  document.getElementById('btnNewSession').addEventListener('click', () => {
    sessionForm.reset();
    document.getElementById('sessionId').value = '';
    sessionFormCard.classList.remove('hidden');
  });

  document.getElementById('btnSessionCancel').addEventListener('click', () => {
    sessionFormCard.classList.add('hidden');
  });

  // --- Initial Load ---
  loadSessions();
</script>

<script>
    document.getElementById('sidebar-toggle').addEventListener('click', function() {
        document.querySelector('.app-container').classList.toggle('sidebar-collapsed');
    });
</script>
<script>// --- Initial Load & Role Check ---
initCommonNav();
if (!getToken()) window.location = '/login.html'; // Ensure user is logged in

const sessionsNavItem = document.getElementById('sessionsNavItem');
const btnNewSession = document.getElementById('btnNewSession');
const contentArea = document.querySelector('.content-area'); // Target the main content

// Check user role immediately
if (sessionsNavItem) {
    if (hasRole('DOCTOR')) {
        // If the user is a Doctor, show the link (it's visible by default, but good practice)
        sessionsNavItem.style.display = 'block';
    } else {
        // If the user is NOT a Doctor, hide the link
        sessionsNavItem.style.display = 'none';

        // BONUS: If they somehow land on sessions.html and aren't a doctor,
        // redirect them or show an access denied message instead of the sessions management content.
        if (contentArea) {
            contentArea.innerHTML = '<h3>Access Denied</h3><p>You do not have permission to manage sessions.</p>';
        }
    }
}
// Also hide the "New Session" button if the user is not a Doctor
if (btnNewSession && !hasRole('DOCTOR')) {
    btnNewSession.style.display = 'none';
}

// ... rest of your sessions.html JavaScript (loadSessions, event listeners, etc.)</script>
</body>
</html>