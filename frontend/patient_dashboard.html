<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Patient Dashboard â€” ClinicMS</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://unpkg.com/gridjs/dist/theme/mermaid.min.css" rel="stylesheet" />

    <style>
        body { background-color: #f4f6f9; font-family: sans-serif; }

        /* Layout */
        .sidebar { width: 250px; height: 100vh; position: fixed; background: white; border-right: 1px solid #eee; }
        .main-wrapper { margin-left: 250px; min-height: 100vh; display: flex; flex-direction: column; }
        .sidebar-header { padding: 20px; font-weight: bold; color: #0d6efd; border-bottom: 1px solid #eee; }
        .nav-link { padding: 12px 20px; color: #333; text-decoration: none; display: block; cursor: pointer; }
        .nav-link:hover, .nav-link.active { background: #e9f2ff; color: #0d6efd; }
        .nav-link i { width: 25px; }

        /* Content */
        .top-bar { background: white; padding: 15px 30px; border-bottom: 1px solid #eee; text-align: right; }
        .content-area { padding: 30px; flex: 1; }

        /* Dashboard Sections */
        .dashboard-section { display: none; }
        .dashboard-section.active { display: block; }

        /* Grid Adjustments */
        .gridjs-wrapper { border-radius: 8px; box-shadow: none; font-size: 0.9rem; }
        .gridjs-head { display: none; /* Hide default GridJS search bar to use our custom one */ }
    </style>
</head>
<body>

<!-- SIDEBAR -->
<nav class="sidebar">
    <div class="sidebar-header">
        <i class="fas fa-heartbeat me-2"></i> Patient Panel
    </div>
    <div class="py-3">
        <a class="nav-link active" onclick="switchTab('find')" id="link-find">
            <i class="fas fa-search"></i> Find Doctor
        </a>
        <a class="nav-link" onclick="switchTab('appointments')" id="link-appointments">
            <i class="fas fa-calendar-check"></i> My Appointments
        </a>
    </div>
</nav>

<!-- MAIN CONTENT -->
<div class="main-wrapper">
    <header class="top-bar">
        <span class="fw-bold text-secondary me-3" id="userLabel">Patient</span>
        <button class="btn btn-sm btn-outline-danger" onclick="logout()"><i class="fas fa-sign-out-alt"></i></button>
    </header>

    <main class="content-area">

        <!-- 1. FIND DOCTOR SECTION -->
        <div id="section-find" class="dashboard-section active">
            <div class="text-center mb-4">
                <h3>Find a Doctor</h3>
                <p class="text-muted">Browse our specialists below.</p>
            </div>

            <!-- Small Search Bar -->
            <div class="row justify-content-center mb-4">
                <div class="col-md-8 col-lg-6">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body p-2">
                            <div class="input-group">
                                <span class="input-group-text bg-white border-0 ps-3"><i class="fas fa-search text-muted"></i></span>
                                <input type="text" id="searchInput" class="form-control border-0 shadow-none" placeholder="Filter by name..." onkeyup="filterGrid()">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Doctor List Table -->
            <div class="card border-0 shadow-sm">
                <div class="card-body p-0">
                    <div id="doctor-grid-wrapper"></div>
                </div>
            </div>
        </div>

        <!-- 2. APPOINTMENTS SECTION -->
        <div id="section-appointments" class="dashboard-section">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <h3>My Appointments</h3>
                    <p class="text-muted">Your scheduled visits.</p>
                </div>
                <button class="btn btn-outline-primary btn-sm" onclick="initAppointmentsGrid()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>

            <div class="card border-0 shadow-sm">
                <div class="card-body p-0">
                    <div id="appointments-grid-wrapper"></div>
                </div>
            </div>
        </div>

    </main>
</div>

<!-- SESSIONS MODAL -->
<div class="modal fade" id="sessionsModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalDoctorName">Doctor Name</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted mb-3">Available Sessions for <span id="modalDoctorSpec"></span></p>
                <div id="sessions-grid-wrapper"></div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/gridjs/dist/gridjs.umd.js"></script>
<script src="assets/js/common.js"></script>

<script>
    const i=getUserId();
    console.log(i);
    let doctorGrid;
    let sessionsGrid = null; // Defined globally to manage state

    document.addEventListener('DOMContentLoaded', () => {
        if (!getToken()) window.location = '/login.html';
        initNav();
        initDoctorGrid();
    });

    // --- 1. LOAD DOCTORS ---
    function initDoctorGrid() {
        const token = getToken();

        doctorGrid = new gridjs.Grid({
            columns: [
                { name: 'Name', id: 'name' },
                { name: 'Specialization', id: 'specialization' },
                {
                    name: 'Action',
                    sort: false,
                    formatter: (cell, row) => {
                        const userId = row.cells[3].data;
                        const name = row.cells[0].data;
                        const spec = row.cells[1].data;

                        return gridjs.html(`
                        <button class="btn btn-sm btn-primary" onclick="openSessions('${userId}', '${name}', '${spec}')">
                            View Sessions
                        </button>
                    `);
                    }
                },
                { name: 'ID', id: 'id', hidden: true }
            ],
            search: true,
            pagination: { limit: 5 },
            server: {
                url: `${API_BASE}/doctor/all`,
                headers: { "Authorization": "Bearer " + token },
                then: data => data.map(doc => [
                    doc.name,
                    doc.specialization,
                    null,
                    doc.userId
                ])
            },
            style: { table: { 'width': '100%' } }
        }).render(document.getElementById("doctor-grid-wrapper"));
    }

    // --- 2. SEARCH FILTER ---
    function filterGrid() {
        const val = document.getElementById('searchInput').value;
        doctorGrid.updateConfig({ search: { keyword: val } }).forceRender();
    }

    // --- 3. VIEW SESSIONS (Updated) ---
    function openSessions(userId, name, spec) {
        document.getElementById('modalDoctorName').textContent = name;
        document.getElementById('modalDoctorSpec').textContent = spec;

        new bootstrap.Modal(document.getElementById('sessionsModal')).show();

        if (sessionsGrid) {
            sessionsGrid.destroy();
        }

        sessionsGrid = new gridjs.Grid({
            columns: ['Date', 'Time', 'Action'],
            pagination: {
                limit: 5,
                server: {
                    url: (prev, page, limit) => `${prev}?page=${page}&size=${limit}`
                }
            },
            server: {
                url: `${API_BASE}/session/doctor/${userId}`,
                headers: { "Authorization": "Bearer " + getToken() },

                then: data => {
                    if (!data.content) return [];

                    return data.content.map(s => {
                        // 1. Construct LocalDateTime string (ISO format: YYYY-MM-DDTHH:mm:ss)
                        // This assumes s.date is "YYYY-MM-DD" and s.startTime is "HH:mm" or "HH:mm:ss"
                        const dateTimeStr = `${s.date}T${s.startTime}`;

                        return [
                            s.date,
                            s.startTime,
                            // 2. Pass sessionId, doctorId (userId), and the dateTimeStr to the book function
                            gridjs.html(`<button class="btn btn-sm btn-success"
                                onclick="book('${s.sessionId}', '${userId}', '${dateTimeStr}')">
                                Book
                            </button>`)
                        ];
                    });
                },
                total: data => data.totalElements
            },
            style: { table: { 'width': '100%' } }
        }).render(document.getElementById("sessions-grid-wrapper"));
    }

    // --- 4. BOOK APPOINTMENT (Updated) ---
    // Added doctorId and appointmentTime to parameters
    window.book = async function(sessionId, doctorId, appointmentTime) {
        if(!confirm("Book this appointment?")) return;

        try {
            const res = await fetch(`${API_BASE}/appointment/create`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Bearer " + getToken()
                },
                // Updated Body to include requested fields
                body: JSON.stringify({
                    patientId: getUserId(),   // Helper function for logged-in user ID
                    doctorId: doctorId,       // Passed from the button click
                    appointmentTime: appointmentTime, // Passed from the button click (LocalDateTime format)
                    sessionId: sessionId
                })
            });

            if(res.ok) {
                alert("Booked Successfully!");
                bootstrap.Modal.getInstance(document.getElementById('sessionsModal')).hide();
                switchTab('appointments');
            } else {
                throw new Error(await res.text());
            }
        } catch(e) {
            alert("Error: " + e.message);
        }
    };

    // --- UTILS ---


    function initNav() {
        const user = JSON.parse(localStorage.getItem('user'));
        if(user) document.getElementById('userLabel').textContent = user.name;
    }

    function logout() { localStorage.clear(); window.location = '/login.html'; }
    // Global variable to store the grid instance
    let appointmentsGrid = null;

    function initAppointmentsGrid() {
        // 1. If grid exists, just reload data (don't create a new table)
        if (appointmentsGrid) {
            appointmentsGrid.forceRender();
            return;
        }

        const patientId = getUserId(); // Get logged-in user ID

        appointmentsGrid = new gridjs.Grid({
            columns: [
                { name: 'Appointment Time', id: 'time' },
                { name: 'Doctor ID', id: 'doctorId' },
                { name: 'Session ID', id: 'sessionId', hidden: true }, // Hidden column
                { name: 'Status', id: 'status' } // Assuming you return a status (e.g., SCHEDULED)
            ],
            pagination: { limit: 5 },
            search: true,
            server: {
                // URL: /appointment/patient/{id}
                url: `${API_BASE}/appointment/patient/${patientId}`,
                headers: { "Authorization": "Bearer " + getToken() },

                then: data => {
                    // If the backend returns a Page object, use data.content.
                    // If it returns a plain List, use data.
                    const appointments = data.content ? data.content : data;

                    return appointments.map(appt => [
                        // 1. Format the Date nicely
                        new Date(appt.appointmentTime).toLocaleString(),

                        // 2. Doctor ID
                        appt.doctorId,

                        // 3. Session ID (Hidden)
                        appt.sessionId,

                        // 4. Status (or default to 'Scheduled')
                        appt.status || 'SCHEDULED'
                    ]);
                }
            },
            style: { table: { 'width': '100%' } }
        }).render(document.getElementById("appointments-grid-wrapper"));
    }
    function switchTab(t) {
        // Hide all sections
        document.querySelectorAll('.dashboard-section').forEach(e => e.classList.remove('active'));
        document.querySelectorAll('.nav-link').forEach(e => e.classList.remove('active'));

        // Show the selected section
        document.getElementById('section-'+t).classList.add('active');
        document.getElementById('link-'+t).classList.add('active');

        // AUTOMATIC LOAD: If the user clicked 'appointments', load the table
        if (t === 'appointments') {
            initAppointmentsGrid();
        }
    }
    // Ensure you have these helpers in assets/js/common.js or defined here:
    // function getToken() { ... }
    // function getUserId() { ... return numeric ID ... }
</script>
</body>
</html>