<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Bills</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="assets/css/styles.css">
  <link rel="stylesheet" href="assets/css/dashboard-styles.css">
</head>
<body>

<div class="app-container">
  <!-- === Sidebar === -->
  <nav class="sidebar">
    <!-- Sidebar Header -->
    <div class="sidebar-header">
      <a class="sidebar-brand" href="dashboard.html">
        <i class="fas fa-clinic-medical"></i>
        <span>ClinicMS</span>
      </a>
      <!-- Toggle Button -->
      <button class="sidebar-toggle" id="sidebar-toggle">
        <i class="fas fa-chevron-left"></i>
      </button>
    </div>

    <ul class="sidebar-nav">
      <li class="nav-title">General</li>
      <li class="nav-item">
        <a class="nav-link" href="dashboard.html">
          <i class="fas fa-home"></i>
          <span>Dashboard</span>
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="patients.html">
          <i class="fas fa-user-injured"></i>
          <span>Patients</span>
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="appointments.html">
          <i class="fas fa-calendar-check"></i>
          <span>Appointments</span>
        </a>
      </li>
      <li class="nav-title">Management</li>
      <li class="nav-item">
        <a class="nav-link" href="doctors.html">
          <i class="fas fa-user-md"></i>
          <span>Doctors</span>
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link active" href="bills.html">
          <i class="fas fa-file-invoice-dollar"></i>
          <span>Billing</span>
        </a>
      </li>
    </ul>
  </nav>

  <!-- === Main Wrapper (Top Bar + Content) === -->
  <div class="main-wrapper">
    <!-- === Top Bar === -->
    <header class="top-bar">
      <form class="search-form d-none d-md-block">
        <input class="form-control" type="search" placeholder="Search bills...">
      </form>
      <div class="profile-dropdown d-flex align-items-center">
        <img src="https://via.placeholder.com/150/4a6cf7/ffffff?text=U" alt="User" class="d-none d-sm-block">
        <div class="me-2 text-end d-none d-sm-block">
          <span id="userLabel" class="d-block"></span>
          <small id="userRoles" class="d-block"></small>
        </div>
        <button id="btnLogout" class="btn btn-logout btn-sm">
          <i class="fas fa-sign-out-alt me-1"></i>Logout
        </button>
      </div>
    </header>

    <!-- === Main Content === -->
    <main class="content-area">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
          <h3>Bills</h3>
          <p class="page-subtitle">Create and manage patient billing.</p>
        </div>
        <button id="btnNew" class="btn btn-primary">
          <i class="fas fa-plus me-1"></i> New Bill
        </button>
      </div>

      <!-- Form Card (hidden by default) -->
      <div id="formCard" class="card mb-4 hidden">
        <div class="card-header">Create New Bill</div>
        <div class="card-body">
          <form id="form">
            <input type="hidden" id="id">
            <div class="row g-3">
              <div class="col-md-3"><label class="form-label">Patient ID</label><input id="patientId" type="number" class="form-control" placeholder="Patient ID" required></div>
              <div class="col-md-3"><label class="form-label">Appointment ID</label><input id="appointmentId" type="number" class="form-control" placeholder="Appointment ID"></div>
              <div class="col-md-3"><label class="form-label">Amount ($)</label><input id="amount" type="number" step="0.01" class="form-control" placeholder="0.00" required></div>
              <div class="col-md-3"><label class="form-label">Created At</label><input id="createdAt" type="datetime-local" class="form-control"></div>
            </div>
            <div class="mt-3">
              <button class="btn btn-primary" type="submit">Save</button>
              <button id="btnCancel" type="button" class="btn btn-secondary">Cancel</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Bills Table -->
      <div class="card">
        <div class="card-header">All Bills</div>
        <div class="card-body table-wrapper">
          <table class="table table-striped table-hover" id="table">
            <thead><tr><th>ID</th><th>Patient ID</th><th>Appt. ID</th><th>Amount</th><th>Created At</th><th>Action</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

    </main>
  </div>
</div>

<script src="assets/js/common.js"></script>
<script>
  initCommonNav();
  if (!getToken()) window.location = '/login.html';

  const tableBody = document.querySelector('#table tbody');

  async function load() {
    try {
      const list = await apiFetch('/bill/all');
      tableBody.innerHTML = '';
      list.forEach(b => {
        const tr = document.createElement('tr');
        const createTime = b.createdAt ? new Date(b.createdAt).toLocaleString('en-US', { dateStyle: 'medium', timeStyle: 'short' }) : '';
        const amount = typeof b.amount === 'number' ? b.amount.toFixed(2) : '0.00';
        tr.innerHTML = `<td>${b.id}</td><td>${b.patientId}</td><td>${b.appointmentId || ''}</td><td>$${amount}</td><td>${createTime}</td>
        <td>${hasRole('ADMIN') || hasRole('BILLING') ? `<button class="btn btn-sm btn-danger" onclick="del(${b.id})"><i class="fas fa-trash-alt"></i></button>` : ''}</td>`;
        tableBody.appendChild(tr);
      });
    } catch (e) {
      tableBody.innerHTML = `<tr><td colspan="6" class="text-danger">Failed to load: ${e.message}</td></tr>`;
    }
  }

  document.getElementById('btnNew').addEventListener('click', () => {
    if (!hasRole('ADMIN') && !hasRole('BILLING')) { alert('No permission'); return; }
    document.getElementById('form').reset();
    document.getElementById('formCard').classList.remove('hidden');
  });
  document.getElementById('btnCancel').addEventListener('click', () => document.getElementById('formCard').classList.add('hidden'));

  document.getElementById('form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const createdAtRaw = document.getElementById('createdAt').value;
    const dto = {
      patientId: Number(document.getElementById('patientId').value),
      appointmentId: document.getElementById('appointmentId').value ? Number(document.getElementById('appointmentId').value) : null,
      amount: Number(document.getElementById('amount').value),
      createdAt: createdAtRaw ? new Date(createdAtRaw).toISOString() : undefined
    };
    try {
      await apiFetch('/bill/create', { method: 'POST', body: JSON.stringify(dto) });
      document.getElementById('formCard').classList.add('hidden');
      load();
    } catch (err) { alert('Save failed: ' + err.message); }
  });

  window.del = async function(id) {
    if (!confirm('Delete bill ' + id + '?')) return;
    try {
      await apiFetch('/bill/' + id, { method: 'DELETE' }); // Corrected path from your original
      load();
    } catch (e) { alert('Delete failed: ' + e.message); }
  };

  load();
</script>

<!-- JavaScript for the sidebar toggle -->
<script>
  document.getElementById('sidebar-toggle').addEventListener('click', function() {
    document.querySelector('.app-container').classList.toggle('sidebar-collapsed');
  });
</script>

</body>
</html>
